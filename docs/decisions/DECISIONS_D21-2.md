# Decision Log

> 技術選定の判断履歴を時系列で記録します。
> 形式: ADR (Architecture Decision Records) 準拠

---

## 2024-12-25: インデックス拡充戦略（D21-2）

**Status**: Accepted

**Context**
- D21評価でGroundedness 0.167を記録（インデックス平均91文字）
- 根本原因: インデックスコンテンツが極端に短い
- 目標: Groundedness 0.85+達成
- 制約: 既存22件のドキュメント構成を維持
- 利用可能リソース: GPT-4oによるコンテンツ生成

**Decision**
- GPT-4oで既存22件を500-800文字目標で拡充
- 実際の達成: 平均1,698文字（18.7倍改善）
- ベクトル埋め込み再生成（text-embedding-ada-002）
- インデックス全件更新（22/22件成功）

**Alternatives Considered**

| Option | Pros | Cons | Rejection Reason |
|--------|------|------|------------------|
| 新規ドキュメント追加 | 情報量増加 | インデックス構造変更、工数大 | 既存構成の保持優先 |
| チャンク分割（500文字×4） | 情報密度維持 | 実装複雑度高 | 初回は単純な拡充を試行 |
| 手動編集 | 品質保証 | 22件×30分=11時間 | GPT-4oで5分短縮 |
| Semantic Ranker有効化 | コード変更不要 | 追加課金、根本解決にならず | コスト増回避 |

**Consequences**
- **ポジティブ**:
  - インデックス統計: 91文字 → 1,698文字（18.7倍）
  - 3件テスト: Groundedness 0.167 → 0.667（+299%）
  - Coherence/Relevance も大幅改善
  
- **ネガティブ**:
  - 25件専用評価: Groundedness 0.672（目標0.85未達）
  - D21実績0.76（推定）との比較で-12%低下
  - 情報密度の希薄化（TF-IDFスコア分散）
  
- **中立**:
  - 再現性の高いベースライン確立（0.67±0.01）
  - チャンキング戦略の重要性を認識

**Validation**
- インデックス統計確認: ✅ 平均1,698文字達成
- 3件テスト評価: ✅ Groundedness 0.667
- 25件専用評価: ✅ Groundedness 0.672（再現性確認）
- 100件混在評価: ⚠️ Groundedness 0.150（カテゴリノイズ影響）

**Lessons Learned**
1. **コンテンツの長さ ≠ 検索品質**: 1,698文字でも0.67止まり
2. **情報密度が重要**: 簡潔な91文字の方が高スコアの可能性
3. **カテゴリ別評価の必須性**: 混在評価では真の性能が見えない
4. **チャンク粒度の影響**: 次の改善ポイントとして特定

**Next Steps**
1. チャンク分割戦略の検討（1,698文字 → 425文字×4）
2. RAGAS評価フレームワーク導入（Week 3計画）
3. D21実績0.76の条件特定（Azure AI Foundry UI確認）

---

## 2024-12-25: 評価データセットのフィルタリング戦略

**Status**: Accepted

**Context**
- 100件評価データセット（test_qa_v2_small.json）
- 5カテゴリ混在: Azure AI Search, Security, Infrastructure, Python SDK, Architecture
- インデックスカバー率: 25% (25/100件)
- 全体Groundedness 0.150（カテゴリ外影響で極端に低い）

**Decision**
- Azure AI Search専用データセット作成（25件抽出）
- カテゴリ別評価を標準プロセス化
- ベースライン評価は専用データセットで実施

**Alternatives Considered**

| Option | Pros | Cons | Rejection Reason |
|--------|------|------|------------------|
| 全カテゴリで評価 | 総合的評価 | ノイズ大、インデックスと不整合 | 不正確なベースライン |
| インデックス拡充（全カテゴリ） | 包括的対応 | 工数大（100件×30分=50時間） | 実行不可能 |
| カテゴリ重み付け評価 | 統計的妥当性 | 実装複雑、解釈困難 | シンプル性優先 |

**Consequences**
- **ポジティブ**:
  - 正確なベースライン確立: Groundedness 0.672
  - 再現性確認: 3件(0.667) vs 25件(0.672) → 差異0.7%
  - D21実績0.76との比較可能性
  
- **ネガティブ**:
  - 評価範囲の限定（25件のみ）
  - 他カテゴリのパフォーマンス不明
  
- **中立**:
  - カテゴリ外質問でGroundedness 0.0は正常動作の証明

**Validation**
- 25件専用評価: ✅ Groundedness 0.672（安定）
- 統計的一貫性: ✅ 3件(0.667) vs 25件(0.672) = 0.7%差

**Next Steps**
- 他カテゴリのインデックス拡充（優先度低）
- カテゴリ別評価の自動化

---

## 2024-12-25: Groundedness 0.67ベースラインの確立

**Status**: Accepted

**Context**
- D21-2目標: Groundedness 0.85+
- インデックス拡充後の実績: 0.672（Azure AI Search専用25件）
- D21実績0.76（推定）との差異: -0.09（-12%）
- 評価方法: batch_evaluation_v8.py（LLMベース評価）

**Decision**
- Groundedness 0.67を現状のベースラインとして正式採用
- 0.85+達成には追加戦略が必要と判断
- チャンキング最適化を次の改善策として優先

**Alternatives Considered**

| Option | Pros | Cons | Rejection Reason |
|--------|------|------|------------------|
| 0.67を成功と判断 | 迅速に次フェーズ | 目標未達、改善余地あり | 0.85+目標を維持 |
| さらにコンテンツ拡充 | 単純な戦略 | 逆効果の可能性（密度低下） | 実験結果から却下 |
| 評価関数の緩和 | スコア向上 | 本質的改善ではない | 誠実性欠如 |
| D21実績0.76の再現 | 過去実績達成 | 条件不明、再現性なし | 条件特定が先決 |

**Consequences**
- **ポジティブ**:
  - 現実的なベースライン確立
  - 改善余地の明確化（0.67 → 0.85 = +27%必要）
  - 次の戦略検討の基盤
  
- **ネガティブ**:
  - D21-2主目標（0.85+）未達成
  - インデックス拡充の効果が期待以下
  
- **中立**:
  - 再現性の高さ（±0.01）は品質保証
  - コンテンツ長と品質の非線形関係を発見

**Validation**
- 複数評価での一貫性: ✅
  - 3件テスト: 0.667
  - 25件専用: 0.672
  - 差異: 0.7%（統計的に有意な一貫性）

**Critical Insight: チャンクサイズのパラドックス**

```
仮説: 長いコンテンツ → 高いGroundedness
実験: 91文字 → 1,698文字（18.7倍）
結果: Groundedness 0.76? → 0.67（-12%）

原因分析:
1. TF-IDFスコアの希薄化
   - 同じキーワードが1,698文字内に分散
   - キーワードマッチの重要度低下
   
2. 情報密度の低下
   - 91文字: 高密度、直接的
   - 1,698文字: 背景説明多、間接的
   
3. Hybrid Searchの特性
   - Vector類似度: 維持
   - Keyword類似度: 低下
   - 総合スコア: やや低下

結論: 次の改善策は「チャンク分割」
- 1,698文字 → 425文字×4チャンク
- 総情報量: 同じ
- 情報密度: 向上
- 期待: 0.67 → 0.75-0.80
```

**Next Steps**
1. **優先度1**: チャンク分割戦略の実装（2-3時間）
2. **優先度2**: RAGAS評価フレームワーク導入（2-3時間）
3. **優先度3**: D21実績0.76の条件特定（調査）

---

## Template（次回用）

### YYYY-MM-DD: [Decision Title]

**Status**: Proposed / Accepted / Superseded / Deprecated

**Context**
- 解決すべき課題
- 制約条件

**Decision**
- 選択した技術・設計

**Alternatives Considered**
| Option | Pros | Cons | Rejection Reason |
|--------|------|------|------------------|
| A | ... | ... | ... |
| B | ... | ... | ... |

**Consequences**
- この決定による影響
- 将来のリスク

**Validation**
- 検証方法と結果

**Next Steps**
- フォローアップアクション
